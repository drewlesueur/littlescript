<!doctype html>
<html>
<head>
<script>

//borrowed from underscore.js
function isArray(obj) {
 return toString.call(obj) === '[object Array]';
}

function isString(obj) {
  return !!(obj === '' || (obj && obj.charCodeAt && obj.substr));
}

function trimLeft(obj) {
  return obj.toString().replace(/^\s+/, "")
}

function trimRight(obj) {
  return obj.toString().replace(/\s+$/, "")
}
 
function s(val, start, end) {
  need_to_join = false
  ret = []
  if  (isString(val)) {
    val = val.split("")
    need_to_join = true
  }
  if (start >= 0) {
  } else {
    start = val.length + start
  }
  if (end == null) {
    ret = val.slice(start)
  } else {
    if (end < 0) {
      end = val.length + end
    } else {
      end = end + start
    }
    ret = val.slice( start, end )
  }
  if (need_to_join) {
    return ret.join("")
  } else {
    return ret
  }
}

function isNumeric(str) {
  return s(line[2], 0, 1).match(/\d/)
}

function startsWith(str, with_what) {
  return s(str, 0, with_what.length) == with_what
}

function parse(txt) {
  functions = []
  txt = txt.split('\n')
  for (var i=0; i < txt.length; i++) {
    line = txt[i]
    line = trimLeft(line)
    code = ""
    code += "function(scope) {"
    
    //create a string
    if ((startsWith(line, "string") || startsWith(line, '"'))) {
      code += 'scope.so = \"' + s(line, line.indexOf(" ") + 1) + '"'
    } else if (startsWith(line, "`")) {
      code += s(line, line.indexOf(" ") + 1)
    } else {

      //other functions
      line = trimRight(line)
      line = line.replace(/\s+/, " ") //only one space
      line = line.split(" ")
      console.log(line)
      if (line[0] == "set" || line[0] == "=") {
        if (!line[2]) {line[2] = "so"}
        second = ""
        if (isNumeric(line[2])) {
          second = line[2]
        } else {
          second = "scope." + line[2]
        }
        code += "scope." + line[1] + " = " + second
      } else if (line[0] == "`") {
        code += s()
      }
    }
    code += "}"
    functions.push(code)
  }
  
  compiled  = "scope = {}\n"
  compiled += "functions = [" + functions.join(",\n") + "\n];\n"
  
  
  compiled += "i = 0;\n"
  compiled += "for (var j=0; j<100; j++) {\n" //"while (true) {\n"
  compiled += "  if (i >= functions.length) {\n"
  compiled += "    break;\n"
  compiled += "  }\n"
  //compiled += "  alert(i);"
  compiled += "  func = functions[i];\n"
  compiled += "  ret = func(scope);\n"
  compiled += "  if ( !(ret === void 0) ) {\n"
  //compiled += "    alert('i is something else ' + i);\n"
  compiled += "    i = ret;\n"
  compiled += "  } else {\n"
  compiled += "    i++;\n"
  compiled += "  }\n"
  compiled += "}\n"
  
  console.log(compiled)
  eval(compiled)
}



 
</script>
</head>
<body>
<input type="button" onclick="parse(document.getElementById('code').value)" value="Run">
<br>
<textarea rows="100" cols="100" id="code">
string hello world
set x
` alert(scope.x)


string made by drew
set drew so
` console.log(scope.drew)
</textarea>

</body>
</html>